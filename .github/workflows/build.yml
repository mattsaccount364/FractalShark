name: Build

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build Fractals
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Checkout MPIR
        uses: actions/checkout@v4
        with:
          repository: BrianGladman/mpir
          path: mpir
          submodules: true

      - name: Initialize MPIR submodules
        working-directory: mpir
        run: git submodule update --init --recursive

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      # ---- Tooling MPIR expects ----

      - name: Install NuGet
        uses: nuget/setup-nuget@v2

      - name: Install YASM
        run: choco install yasm -y

      - name: Install VSYASM (NuGet)
        shell: pwsh
        run: |
          nuget install vsyasm -ExcludeVersion -OutputDirectory "$env:RUNNER_TEMP\vsyasm"

          $root = Join-Path $env:RUNNER_TEMP "vsyasm"
          $exe  = Get-ChildItem -Path $root -Recurse -Filter "vsyasm.exe" -File |
                  Select-Object -First 1

          if (-not $exe) {
            throw "vsyasm.exe not found under $root"
          }

          $vsyasmDir = $exe.Directory.FullName
          Write-Host "Found vsyasm.exe at $($exe.FullName)"

          # Put vsyasm.exe on PATH
          echo $vsyasmDir | Out-File -FilePath $env:GITHUB_PATH -Append
          
          #$env:YASM_PATH = "$vsyasmDir\"
          #"YASM_PATH=$env:YASM_PATH" | Out-File -FilePath $env:GITHUB_ENV -Append
          #Write-Host "YASM_PATH (this step): $env:YASM_PATH"

          # Make MPIR pick it up
          echo "YASMInstallDir=$vsyasmDir\" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "YASMINSTALLDIR=$vsyasmDir\" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Set YASM_PATH
        shell: pwsh
        run: |
          $yasmExe = (Get-Command yasm.exe -ErrorAction Stop).Source
          $yasmDir = Split-Path $yasmExe -Parent
      
          # Set for THIS step
          $env:YASM_PATH = "$yasmDir\"
      
          # Persist for NEXT steps
          "YASM_PATH=$env:YASM_PATH" | Out-File -FilePath $env:GITHUB_ENV -Append
      
          Write-Host "YASM_PATH (this step): $env:YASM_PATH"

      - name: Verify YASM_PATH (next step)
        shell: pwsh
        run: |
          Write-Host "YASM_PATH (next step): $env:YASM_PATH"

      - name: Verify vsyasm
        shell: pwsh
        run: |
          Copy-Item "$env:YASM_PATH\yasm.exe" "$env:YASM_PATH\vsyasm.exe"
          dir "$env:YASM_PATH"

      # ---- Build MPIR (official entrypoint) ----

      - name: Build MPIR (skylake_avx, Release x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Release

      - name: Build MPIR (skylake_avx, Debug x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Debug

      # ---- Stage mpir.lib where FractalShark expects it ----
      - name: Stage mpir.lib
        shell: pwsh
        run: |
          $root = Join-Path $env:GITHUB_WORKSPACE "mpir"

          $dstRel = Join-Path $root "lib\x64\Release"
          $dstDbg = Join-Path $root "lib\x64\Debug"
          New-Item -ItemType Directory -Force -Path $dstRel, $dstDbg | Out-Null

          Get-ChildItem $root -Recurse -Filter mpir.lib |
            ForEach-Object {
              if ($_.FullName -match "\\Release\\") {
                Copy-Item $_.FullName (Join-Path $dstRel "mpir.lib") -Force
              }
              if ($_.FullName -match "\\Debug\\") {
                Copy-Item $_.FullName (Join-Path $dstDbg "mpir.lib") -Force
              }
            }

      # ---- CUDA ----
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "13.0.2"

      # ---- Build FractalShark ----
      - name: Build Debug
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Debug /p:Platform=x64 /p:PlatformToolset=v143

      - name: Build Release
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: FractalShark-build
          path: |
            **/Release/**
            **/x64/Release/**
            **/Debug/**
            **/x64/Debug/**
