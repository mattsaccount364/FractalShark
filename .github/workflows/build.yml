name: Build

on:
  push:
    branches: ["**"]
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build FractalShark
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Checkout MPIR
        uses: actions/checkout@v4
        with:
          repository: BrianGladman/mpir
          path: mpir
          submodules: true

      - name: Initialize MPIR submodules
        working-directory: mpir
        run: git submodule update --init --recursive

      - name: Install VC++ 2010 runtime (for vsyasm)
        shell: pwsh
        run: |
          choco install vcredist2010 -y

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      # ---- Tooling MPIR expects ----

      - name: Install NuGet
        uses: nuget/setup-nuget@v2

      # Note 2025-12: Tried various current vsyasm but failed.  Just
      # keeping custom one for now.
      - name: Extract bundled tools to Program Files
        shell: pwsh
        run: |
          $zip = Join-Path $env:GITHUB_WORKSPACE "tools\yasm.zip"
          $dst = "C:\Program Files\vsyasm"

          Write-Host "ZIP path: $zip"
          if (-not (Test-Path $zip)) {
            throw "Zip not found at $zip. Check repo path/casing and that the file is committed."
          }

          $item = Get-Item $zip
          Write-Host ("Zip size: {0:n0} bytes" -f $item.Length)

          # Detect Git LFS pointer (typically tiny and starts with 'version https://git-lfs.github.com/spec/v1')
          $firstLine = (Get-Content -Path $zip -TotalCount 1 -ErrorAction SilentlyContinue)
          if ($item.Length -lt 2000 -and $firstLine -like "version https://git-lfs.github.com/spec/v1*") {
            throw "This file is a Git LFS pointer, not the real zip. Fix: set actions/checkout@v4 with `lfs: true`."
          }

          # Clean install location
          if (Test-Path $dst) { Remove-Item -Recurse -Force $dst }
          New-Item -ItemType Directory -Force -Path $dst | Out-Null

          # Unzip
          Expand-Archive -Path $zip -DestinationPath $dst -Force

          # Unblock extracted EXEs (Windows MOTW)
          Get-ChildItem -Path $dst -Recurse -File | Unblock-File

          # Find the actual bin dir (handles nested folders inside the zip)
          $exe = Get-ChildItem -Path $dst -Recurse -Filter "vsyasm.exe" -File | Select-Object -First 1
          if (-not $exe) { throw "vsyasm.exe not found anywhere under $dst after unzip." }

          $binDir = $exe.Directory.FullName
          Write-Host "Using bin dir: $binDir"
          Get-ChildItem $binDir | Format-Table -AutoSize

          # PATH + env vars for later steps
          $binDir | Out-File -FilePath $env:GITHUB_PATH -Append
          "YASMInstallDir=$binDir\"  | Out-File -FilePath $env:GITHUB_ENV -Append
          "YASMINSTALLDIR=$binDir\"  | Out-File -FilePath $env:GITHUB_ENV -Append
          "YASM_PATH=$binDir\"       | Out-File -FilePath $env:GITHUB_ENV -Append

          try {
            & $exe.FullName /?
          } catch {
            # ignore
          }
          $LASTEXITCODE = 0
      
      # Originally it wouldn't load.  Used this to sort out it was missing the VC runtime dependency.
      - name: Dump DLL dependencies (vsyasm)
        shell: pwsh
        run: |
          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) {
            throw "vswhere.exe not found"
          }
      
          $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (-not $vsPath) {
            throw "Visual Studio with VC tools not found"
          }
      
          $vcvars = Join-Path $vsPath "VC\Auxiliary\Build\vcvars64.bat"
          if (-not (Test-Path $vcvars)) {
            throw "vcvars64.bat not found"
          }
      
          cmd /c "`"$vcvars`" >nul && dumpbin /dependents `"C:\Program Files\vsyasm\vsyasm.exe`""


      # See if the damn thing runs
      - name: Verify vsyasm/yasm are visible
        shell: pwsh
        run: |
          Write-Host "YASM_PATH: $env:YASM_PATH"
          Get-Command vsyasm.exe -ErrorAction Stop | Format-List
          Get-Command yasm.exe   -ErrorAction SilentlyContinue | Format-List
    
      - name: Try running vsyasm directly (diagnostic)
        shell: pwsh
        continue-on-error: true
        run: |
          & "C:\Program Files\vsyasm\vsyasm.exe" --version
          Write-Host "Exit code: $LASTEXITCODE"
          
      # ---- Build MPIR (official entrypoint) ----

      - name: Build MPIR (skylake_avx, Release x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Release

      - name: Build MPIR (skylake_avx, Debug x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Debug

      # ---- CUDA ----
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "13.0.2"

      # ---- Build FractalShark ----
      - name: Build Debug
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Debug /p:Platform=x64 /p:PlatformToolset=v143

      - name: Build Release
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: FractalShark-build
          path: |
            **/Release/**
            **/x64/Release/**
            **/Debug/**
            **/x64/Debug/**
  release:
    name: Create FractalShark Release
    runs-on: windows-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: FractalShark-build
          path: dist

      - name: Package artifacts (zip)
        shell: pwsh
        run: |
          $releaseDir = Join-Path $PWD "dist\Release"
          $exe = Join-Path $releaseDir "FractalShark.exe"
          $pdb = Join-Path $releaseDir "FractalShark.pdb"

          if (-not (Test-Path $exe)) { throw "Missing: $exe" }
          if (-not (Test-Path $pdb)) { throw "Missing: $pdb" }

          New-Item -ItemType Directory -Force -Path out | Out-Null

          Compress-Archive -Path @($exe, $pdb) `
            -DestinationPath ("out\FractalShark-{0}.zip" -f $env:GITHUB_REF_NAME) `
            -Force

          Get-ChildItem out | Format-Table -AutoSize

      - name: Create Release and upload asset
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$env:GITHUB_REF_NAME" `
            --title "FractalShark $env:GITHUB_REF_NAME" `
            --notes "Automated release for $env:GITHUB_REF_NAME" `
            --prerelease `
            "out\FractalShark-$env:GITHUB_REF_NAME.zip"
