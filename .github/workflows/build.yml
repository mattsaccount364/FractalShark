name: Build

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build Fractals
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Checkout MPIR
        uses: actions/checkout@v4
        with:
          repository: BrianGladman/mpir
          path: mpir
          submodules: true

      - name: Initialize MPIR submodules
        working-directory: mpir
        run: git submodule update --init --recursive

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      # ---- Tooling MPIR expects for its VS projects ----

      - name: Install NuGet
        uses: nuget/setup-nuget@v2

      - name: Install YASM
        run: choco install yasm -y

      - name: Install VSYASM (NuGet)
        shell: pwsh
        run: |
          nuget install vsyasm -ExcludeVersion -OutputDirectory "$env:RUNNER_TEMP\vsyasm"

          # Find vsyasm.exe anywhere under the output directory (NuGet uses versioned subfolders)
          $root = Join-Path $env:RUNNER_TEMP "vsyasm"
          $exe  = Get-ChildItem -Path $root -Recurse -Filter "vsyasm.exe" -File -ErrorAction SilentlyContinue |
                  Select-Object -First 1

          if (-not $exe) {
            Write-Host ("Contents under {0}:" -f $root)
            Get-ChildItem -Path $root -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
            throw ("vsyasm.exe not found under {0}" -f $root)
          }

          $vsyasmDir = $exe.Directory.FullName
          Write-Host ("Found vsyasm.exe at: {0}" -f $exe.FullName)
          echo $vsyasmDir | Out-File -FilePath $env:GITHUB_PATH -Append

      # Tell VSYASM where yasm.exe is (important: no embedded quotes)
      - name: Set YASMPATH (directory containing yasm.exe)
        shell: pwsh
        run: |
          $yasmExe = (Get-Command yasm.exe -ErrorAction Stop).Source
          $yasmDir = Split-Path $yasmExe -Parent
          # VSYASM expects YASMPATH to point at the directory containing yasm.exe
          echo "YASMPATH=$yasmDir\" | Out-File -FilePath $env:GITHUB_ENV -Append

      # ---- CUDA for your main build ----
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "13.0.2"

      # ---- Build MPIR via its supported entrypoint (avoids missing cfg.h / cdata issues) ----
      - name: Build MPIR (skylake_avx, Release x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Release

      - name: Build MPIR (skylake_avx, Debug x64)
        working-directory: mpir\msvc\vs22
        shell: cmd
        run: msbuild.bat skylake_avx LIB x64 Debug
        
      # ---- Make MPIR visible to your vcxprojs (they look in ..\mpir\lib\x64\{Debug|Release}\mpir.lib) ----
      - name: Stage mpir.lib into expected folders
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $root = Join-Path $env:GITHUB_WORKSPACE "mpir"
          $dstRel = Join-Path $root "lib\x64\Release"
          $dstDbg = Join-Path $root "lib\x64\Debug"
          New-Item -ItemType Directory -Force -Path $dstRel, $dstDbg | Out-Null

          function Copy-MpirLib([string]$cfg, [string]$dst) {
            $candidates = Get-ChildItem -Path $root -Recurse -Filter "mpir.lib" -File -ErrorAction Stop |
              Where-Object { $_.FullName -match "\\$cfg\\" }
            if (-not $candidates) { $candidates = Get-ChildItem -Path $root -Recurse -Filter "mpir.lib" -File }
            if (-not $candidates) { throw "mpir.lib not found under $root" }
            Copy-Item -Force $candidates[0].FullName (Join-Path $dst "mpir.lib")
            Write-Host "Copied $($candidates[0].FullName) -> $(Join-Path $dst "mpir.lib")"
          }

          Copy-MpirLib "Release" $dstRel
          Copy-MpirLib "Debug"   $dstDbg

      # ---- Build your project ----
      - name: Build Debug
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Debug /p:Platform=x64

      - name: Build Release
        run: msbuild FractalShark\FractalShark.sln /p:Configuration=Release /p:Platform=x64

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: FractalShark-build
          path: |
            **/Release/**
            **/x64/Release/**
            **/Debug/**
            **/x64/Debug/**
